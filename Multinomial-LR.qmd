---
title: "Multinomial Logistic Regression"
subtitle: "Advanced Categorical Data Analysis"
author: "Dr Muhammad Saufi"
date: last-modified
format: 
  html:
    toc: true
    toc-title: Contents
    toc-location: left
    toc-depth: 5
    toc-expand: 1
    number-sections: true
    code-link: true
    theme:
      light: united
      dark: cyborg
    css: styles.css
    self-contained: true
editor: visual
include-after-body: "footer.html"
---

::: {.callout-note collapse="true"}
# About This Document

This document serves both learning and practical purposes. It is designed for educational use, aiming to enhance statistical analysis skills and provide clear, organized notes for future reference.
:::

# Introduction

Multinomial Logistic Regression is an extension of binary logistic regression that allows for the modeling of outcome variables with more than two categories. This type of regression is used when the outcome categories are nominal, meaning they do not have a natural order. The dependent variable has multiple categories (more than two), and one of the categories is chosen as the reference category. The model compares each of the other categories to this reference category.

## Model Structure

-   The model estimates the log odds of each category relative to the reference category.
-   For a categorical outcome with $k$ categories, the model fits $k-1$ equations.
-   Each equation models the log odds of a specific category relative to the reference category.

## Model Formulation

1.  **Log Odds**

-   The log odds of being in category $j$ relative to the reference category $0$ is modeled as:

$$
\log \left( \frac{P(Y=j|X)}{P(Y=0|X)} \right) = \alpha_j + \beta_{j1}X_1 + \beta_{j2}X_2 + \ldots + \beta_{jp}X_p
$$

::: callout-note
$\alpha_j$ is the intercept for category $j$, and $\beta_{jk}$ are the coefficients for the predictor variables $X_k$.
:::

2.  **Probability**

-   The probability of being in category $j$ is derived from the log odds:

$$
P(Y=j|X) = \frac{e^{\alpha_j + \beta_{j1}X_1 + \beta_{j2}X_2 + \ldots + \beta_{jp}X_p}}{1 + \sum_{l=1}^{k-1} e^{\alpha_l + \beta_{l1}X_1 + \beta_{l2}X_2 + \ldots + \beta_{lp}X_p}}
$$

-   The probability of being in the reference category $0$ is:

$$
P(Y=0|X) = \frac{1}{1 + \sum_{l=1}^{k-1} e^{\alpha_l + \beta_{l1}X_1 + \beta_{l2}X_2 + \ldots + \beta_{lp}X_p}}
$$

## Estimation

-   The parameters ($\alpha_j$ and $\beta_{jk}$) are estimated using maximum likelihood estimation (MLE).
-   The likelihood function is constructed based on the observed data and the probabilities of each category.
-   Iterative algorithms, such as Newton-Raphson or Fisher scoring, are used to find the parameter estimates that maximize the likelihood function.

## Interpretation

1.  **Coefficients (**$\beta$)

    -   The coefficients represent the change in the log odds of being in a category relative to the reference category for a one-unit change in the predictor variable.
    -   Positive coefficients indicate higher odds of being in the category compared to the reference, while negative coefficients indicate lower odds.

2.  **Odds Ratios (OR)** is obtained by exponentiating the coefficients:

$$
OR = e^{\beta}
$$

::: callout-note
An OR greater than 1 indicates increased odds of being in the category compared to the reference, and an OR less than 1 indicates decreased odds.
:::

## Model Fit and Diagnostics

-   **Likelihood Ratio Test**: Used to compare nested models and assess the significance of adding or removing predictors.
-   **Wald Test**: Used to test the significance of individual coefficients.

# Setting Up the Environment

Load the necessary libraries to ensure the R environment is equipped with the tools and functions required for efficient and effective analysis.

```{r, warning=FALSE, message=FALSE}
library(here)
library(tidyverse)
library(haven)
library(gtsummary)
library(VGAM)
library(knitr)
library(kableExtra)
library(nnet)
library(foreign)
library(readxl)
```

# Practical 1: Mammography Experience Dataset

In this exercise, the objectives are to understand and apply multinomial logistic regression using a dataset related to mammography experiences. The focus is on analyzing the mammography experiences dataset to understand factors influencing whether women have had a mammogram recently, a long time ago, or never.

## Dataset Overview

The dataset used is focused on mammography experiences which consists of responses from a survey on mammography experiences and perceptions. The dataset includes the following variables:

1.  **me (Mammography Experience)**: This is the outcome variable and is categorical with three levels:

    -   `0`: Never had a mammogram
    -   `1`: Had a mammogram within a year
    -   `2`: Had a mammogram over a year ago

2.  **sympt (Symptoms Perception)**: This variable captures the perception that a mammogram is not needed unless symptoms are present.

    -   `1`: Strongly Agree
    -   `2`: Agree
    -   `3`: Disagree
    -   `4`: Strongly Disagree

3.  **pb (Perceived Benefit of Mammography)**: This variable measures the perceived benefit of mammography on a scale. The exact scale is not specified but typically ranges from lower to higher perceived benefits.

4.  **hist (Family History of Breast Cancer)**: This binary variable indicates whether the respondent has a family history (mother or sister) of breast cancer.

    -   `0`: No
    -   `1`: Yes

5.  **bse (Breast Self-Examination Training)**: This binary variable indicates whether the respondent has been taught how to perform breast self-examinations.

    -   `0`: No
    -   `1`: Yes

6.  **detc (Detection Likelihood)**: This variable measures the respondent's perception of the likelihood that a mammogram could detect a new case of breast cancer. It is coded as:

    -   `1`: Not likely
    -   `2`: Somewhat likely
    -   `3`: Very likely

## Data Reading and Exploration

```{r}
# Read the data
dat.m1 <- read_dta("Datasets/mammog9.dta")

# Explore the data
glimpse(dat.m1)
summary(dat.m1)
```

## Data Wrangling

The `me` and `hist` variables are treated as numerical despite being categorical variables. To ensure that the data is handled correctly during statistical analyses, these variables must be converted to factors so that each level is treated as a distinct category, and the analysis methods can correctly interpret these categories.

### `me` Variable

```{r}
# Counting the Original `me` Variable
dat.m1 %>% count(me)
```

```{r}
# Copy dataset and keep the original dataset
dat.m2 <- dat.m1

# Converting `me` to a factor
dat.m2 <- dat.m2 %>%
  mutate(me2 = factor(me, labels = c("never", "within.a.year", "over.a.year.ago")))
dat.m2 %>% count(me2)
```

::: callout-note
This code creates a new variable `me2` by converting the numeric `me` variable to a factor. The `labels` argument assigns meaningful labels to the factor levels.
:::

### `hist` Variable

```{r}
# Counting the Original `hist` Variable
dat.m2 %>% count(hist)
```

```{r}
# Converting `hist` to a Factor
dat.m2 <- dat.m2 %>% mutate(hist2 = factor(hist, labels = c("no", "yes")))
dat.m2 %>% count(hist2)
```

::: callout-note
This code creates a new variable `hist2` by converting the numeric `hist` variable to a factor, with `no` and `yes` as labels.
:::

### Table Summary

```{r}
# Generate summary statistics for the dataset, grouped by the `me2` variable
dat.m2 %>%
  select(-me, -hist) %>%
  tbl_summary(by = me2, statistic = list(all_continuous() ~ "{mean} ({sd})"))
```

## Estimation

The VGAM package is used to run multinomial logistic regression, which is suitable for a dependent variable with more than two categories. The objctive is to use the VGAM package to fit a multinomial logistic regression model and ensure the reference category for the dependent variable `me2` is "never".

### Confirm the Order of Factor Levels

Check the current order of the factor levels for `me2`. It is crucial because the reference level in regression models affects the interpretation of coefficients.

```{r}
levels(dat.m2$me2)
```

::: callout-note
The levels are currently in the order where "never" is the first level. For the model, we need "never" to be the last level to serve as the reference category.
:::

### Reorder the Factor Levels

```{r}
# Create new dataset `dat.m3`
dat.m3 <- dat.m2

# Generate `me3`
dat.m3 <- dat.m3 %>%
  mutate(me3 = fct_relevel(me2, c("over.a.year.ago", "within.a.year", "never")))
```

::: callout-note
Creates a new variable `me3` by reordering the levels of `me2` using `fct_relevel` so that "never" becomes the reference level.
:::

```{r}
table(dat.m3$me)
```

------------------------------------------------------------------------

```{r}
summary(dat.m3$me2)
```

------------------------------------------------------------------------

```{r}
summary(dat.m3$me3)
```

::: callout-note
These functions confirm that the observations and levels are correctly adjusted after releveling.
:::

### Check the Order of Levels

```{r}
levels(dat.m3$me2)
```

------------------------------------------------------------------------

```{r}
levels(dat.m3$me3)
```

::: callout-note
This checks the new order of levels to ensure that `me3` has "never" as the last level (reference category).
:::

### Multinomial Logistic Regression Model

#### Model with `hist2` as Predictor

```{r}
fitmlog1 <- vglm(me3 ~ hist2,
  family = multinomial(),
  data = dat.m3
)
summary(fitmlog1)
```

------------------------------------------------------------------------

-   `vglm(me3 ~ hist2, family = multinomial(), data = dat.m1)`: Fits a model where `me3` (mammography experience) is the dependent variable, and `hist2` (family history of breast cancer) is the predictor.
-   `family = multinomial()`: Specifies that the model is a multinomial logistic regression.
-   `data = dat.m3`: Specifies the dataset to be used.

------------------------------------------------------------------------

**Summary of Output**

1.  **Intercepts**

    -   `(Intercept):1`: The log-odds of being in the "over a year ago" category relative to "never" when `hist2` is the reference level (no family history).
    -   `(Intercept):2`: The log-odds of being in the "within a year" category relative to "never" when `hist2` is the reference level (no family history).

2.  **Predictor (`hist2yes`)**

    -   `hist2yes:1`: The log-odds change of being in the "over a year ago" category relative to "never" for participants with a family history of breast cancer compared to those without.
    -   `hist2yes:2`: The log-odds change of being in the "within a year" category relative to "never" for participants with a family history of breast cancer compared to those without.

3.  **Statistical Significance**

    -   `(Intercept):1` and `(Intercept):2` are highly significant (p \< 0.001), indicating that the intercepts are significantly different from zero.
    -   `hist2yes:1` is significant at the 0.05 level (`*`), indicating that the log-odds change for the "over a year ago" category relative to "never" is significant for those with a family history of breast cancer.
    -   `hist2yes:2` is highly significant (p \< 0.001), indicating that the log-odds change for the "within a year" category relative to "never" is significant for those with a family history of breast cancer.

4.  **Interpretation**

    -   The model indicates that having a family history of breast cancer (hist2 = "yes") significantly affects the likelihood of having had a mammogram "within a year" or "over a year ago" compared to "never".
    -   Significant positive coefficients for `hist2yes` suggest that participants with a family history of breast cancer are more likely to have had a mammogram within a year or over a year ago compared to those without a family history.
    -   The model fit statistics (residual deviance, log-likelihood) suggest that the model adequately fits the data.

#### Model with `detc` as Predictor

```{r}
# Convert `detc` to a factor
dat.m3 <- dat.m3 %>% mutate(detc2 = factor(detc))

# Check the distribution of `detc2` across the levels of `me3`
table(dat.m3$me3, dat.m3$detc2)
```

::: callout-note
The table shows the count of observations for each combination of `me2` and `detc2`.
:::

```{r}
# Fitting the model with `detc2` as predictor
fitmlog2 <- vglm(me3 ~ detc2,
  family = multinomial(),
  data = dat.m3
)
summary(fitmlog2)
```

------------------------------------------------------------------------

**Summary of Output**

1.  **Intercepts**

    -   `(Intercept):1`: The log-odds of being in the "over a year ago" category relative to "never" when `detc2` is at its reference level (usually the first level).
    -   `(Intercept):2`: The log-odds of being in the "within a year" category relative to "never" when `detc2` is at its reference level.

2.  **Predictor (`detc2`)**

    -   `detc22:1`: The log-odds change of being in the "over a year ago" category relative to "never" for participants with the second level of `detc2` compared to the reference level.
    -   `detc22:2`: The log-odds change of being in the "within a year" category relative to "never" for participants with the second level of `detc2` compared to the reference level.
    -   `detc23:1`: The log-odds change of being in the "over a year ago" category relative to "never" for participants with the third level of `detc2` compared to the reference level.
    -   `detc23:2`: The log-odds change of being in the "within a year" category relative to "never" for participants with the third level of `detc2` compared to the reference level.

3.  \*\*Statistical Significance\*

    -   `(Intercept):1` is significant at the 0.05 level (`*`), indicating that the intercept for the "over a year ago" category relative to "never" is significantly different from zero.
    -   `detc23:2` is significant at the 0.05 level (`*`), indicating that the log-odds change for the "within a year" category relative to "never" is significant for those at the third level of `detc2`.

4.  **Interpretation**

    -   The model indicates that the perceived likelihood of detection (`detc2`) has an effect on the likelihood of having had a mammogram "within a year" compared to "never".
    -   Significant positive coefficient for `detc23:2` suggests that participants with the highest level of perceived likelihood of detection are more likely to have had a mammogram within a year compared to those with the lowest level of perceived likelihood.
    -   The model fit statistics (residual deviance, log-likelihood) suggest that the model adequately fits the data.

## Inferences

Inferences refer to the process of drawing conclusions about a population based on the analysis of sample data. In multinomial logistic regression model, inferences involve estimating the relationships between the predictor variables and the outcome variable and determining the statistical significance and confidence of these estimates. The process of inferences involves:

1.  Calculate the 95% Confidence Intervals (CIs) for the model coefficients.
2.  Calculate the p-values for hypothesis testing.
3.  Exponentiate the coefficients to obtain the Relative Risk Ratios (RRRs).

### Calculate 95% Confidence Intervals and Combine with Coefficients

```{r}
# Extract coefficients from the model
b_fitmlog2 <- coef(fitmlog2)

# Calculate confidence intervals
ci_fitmlog2 <- confint(fitmlog2)

# Combine coefficients and confidence intervals
b_ci_fitmlog2 <- cbind(b_fitmlog2, ci_fitmlog2)
b_ci_fitmlog2
```

------------------------------------------------------------------------

-   **`coef(fitmlog2)`**: Extracts the estimated coefficients from the model `fitmlog2`.
-   **`confint(fitmlog2)`**: Calculates the 95% confidence intervals for the model coefficients.
-   **`cbind(b_fitmlog2, ci_fitmlog2)`**: Combines the coefficients and their confidence intervals into a single table.
-   **`b_fitmlog2`**: The estimated coefficients.
-   **`2.5 %` and `97.5 %`**: The lower and upper bounds of the 95% confidence intervals for each coefficient.

### Exponentiate Coefficients to Obtain Relative Risk Ratios (RRRs)

```{r}
# Exponentiate the combined coefficients and confidence intervals
rrr_fitmlog2 <- exp(b_ci_fitmlog2)

# Combine the RRRs with the original table
tab_fitmlog2 <- cbind(b_ci_fitmlog2, rrr_fitmlog2)

# Name the columns of the combined table
colnames(tab_fitmlog2) <- c("b", "lower b", "upper b", "rrr", "lower rrr", "upper rrr")

# Display the combined table
tab_fitmlog2
```

------------------------------------------------------------------------

-   **`exp(b_ci_fitmlog2)`**: Exponentiates the coefficients and their confidence intervals to obtain the RRRs.
-   **`cbind(b_ci_fitmlog2, rrr_fitmlog2)`**: Combines the original table with the RRRs.
-   **`colnames(tab_fitmlog2) <- c('b', 'lower b', 'upper b', 'rrr', 'lower rrr', 'upper rrr')`**: Renames the columns of the combined table for clarity.
-   **`b`**: The estimated coefficients.
-   **`lower b` and `upper b`**: The lower and upper bounds of the 95% confidence intervals for the coefficients.
-   **`rrr`**: The Relative Risk Ratios (exponentiated coefficients).
-   **`lower rrr` and `upper rrr`**: The lower and upper bounds of the 95% confidence intervals for the RRRs.

**Interpretation**

------------------------------------------------------------------------

-   (Intercept):1

    -   The log-odds of being in the "over a year ago" category relative to "never" are -1.1786550 when all predictors are at their reference levels.
    -   The confidence interval for this log-odds is \[-2.29930795, -0.0580204\], indicating it is statistically significant since it does not include zero.
    -   The relative risk ratio (RRR) is 0.3076921, meaning that the likelihood of being in the "over a year ago" category is about 0.31 times that of the "never" category.
    -   The 95% confidence interval for the RRR is \[0.10032825, 0.9434680\], indicating the precision of the estimate.

-   detc22:1

    -   The log-odds of being in the "over a year ago" category relative to "never" decrease by 0.3925617 for each one-unit increase in `detc22`.
    -   The confidence interval for this coefficient is \[-1.63588117, 0.85075776\], which includes zero, indicating it is not statistically significant.
    -   The RRR is 0.67532468, meaning the likelihood decreases to about 0.68 times for each one-unit increase in `detc22`.
    -   The 95% confidence interval for the RRR is \[0.19478066, 2.3414204\].

-   detc23:1

    -   The log-odds of being in the "over a year ago" category relative to "never" increase by 0.1978257 for each one-unit increase in `detc23`.
    -   The confidence interval for this coefficient is \[-0.96556939, 1.36130242\], which includes zero, indicating it is not statistically significant.
    -   The RRR is 1.21875000, meaning the likelihood increases to about 1.22 times for each one-unit increase in `detc23`.
    -   The 95% confidence interval for the RRR is \[0.38073529, 3.9012711\].

------------------------------------------------------------------------

-   (Intercept):2

    -   The log-odds of being in the "within a year" category relative to "never" are -2.5649494 when all predictors are at their reference levels.
    -   The confidence interval for this log-odds is \[-4.59888160, -0.5310171\], indicating it is statistically significant.
    -   The RRR is 0.07692308, meaning that the likelihood of being in the "within a year" category is about 0.08 times that of the "never" category.
    -   The 95% confidence interval for the RRR is \[0.01006308, 0.5888066\].

-   detc22:2

    -   The log-odds of being in the "within a year" category relative to "never" increase by 0.7060506 for each one-unit increase in `detc22`.
    -   The confidence interval for this coefficient is \[-1.41689336, 2.82899454\], which includes zero, indicating it is not statistically significant.
    -   The RRR is 2.02597403, meaning the likelihood increases to about 2.03 times for each one-unit increase in `detc22`.
    -   The 95% confidence interval for the RRR is \[0.24246610, 16.9284133\].

-   detc23:2

    -   The log-odds of being in the "within a year" category relative to "never" increase by 2.1059956 for each one-unit increase in `detc23`.
    -   The confidence interval for this coefficient is \[0.05519791, 4.15679321\], indicating it is statistically significant since it does not include zero.
    -   The RRR is 8.21527778, meaning the likelihood increases to about 8.22 times for each one-unit increase in `detc23`.
    -   The 95% confidence interval for the RRR is \[1.05674974, 63.8663880\], indicating a high degree of variability in the estimate.

# Practical 2: Additional Covariates

In this exercise, the objective is to extend the initial multinomial logistic regression model by adding more covariates to better understand the relationships between the predictors and the outcome variable. This helps in refining the model and potentially improving its explanatory power.

## Estimation

Define the additional covariates to be included in the model. These include variables such as:

-   `sympt` (perception of symptoms)
-   `pb` (perceived benefit)
-   `hist` (family history)
-   `bse` (breast self-exam training)
-   `detc` (detection likelihood)

### Defining the Model

The model is specified as a multinomial logistic regression, with the dataset `dat.m3`. The additional covariates are included in the model.

```{r}
# Fitting the model with additional covariates
fitmlog3 <- vglm(me3 ~ factor(sympt) + pb + hist2 + bse + detc2,
  family = multinomial(),
  data = dat.m3
)
summary(fitmlog3)
```

------------------------------------------------------------------------

-   `vglm()`: Fits a multinomial logistic regression model with `me3` as the dependent variable and the specified covariates as predictors.
-   `factor(sympt)` converts `sympt` to a factor variable.

### Checking and Recoding `sympt` Variable

The variable `sympt` has 4 categories, hence it is needed to be recoded into a binary factor variable `symptd` for simplicity.

```{r}
# Original `sympt` variable
dat.m3 %>% count(sympt)
```

```{r}
# recode `sympt` into a binary variable `symptd`
dat.m3 <- dat.m3 %>%
  mutate(symptd = ifelse(sympt < 3, "<3", "3 or more"))
dat.m3 %>% count(sympt, symptd)
```

------------------------------------------------------------------------

-   `mutate(symptd = ifelse(sympt < 3, '<3', '3 or more'))`: Recode `sympt` into a binary variable `symptd`, where categories less than 3 are labeled `<3` and categories 3 or more are labeled `3 or more`.

### Refit the Model with New `symptd` Variable

```{r}
# Refit the model using the new binary variable `symptd`
fitmlog4 <- vglm(me3 ~ symptd + pb + hist2 + bse + detc2,
  family = multinomial(),
  data = dat.m3
)
summary(fitmlog4)
```

------------------------------------------------------------------------

**Summary of Output**

1.  Intercepts

    -   **(Intercept):1**: The log-odds of being in the "over a year ago" category relative to "never" are -0.99877 when all predictors are at their reference levels. This is not statistically significant (p = 0.351485).
    -   **(Intercept):2**: The log-odds of being in the "within a year" category relative to "never" are -2.70375 when all predictors are at their reference levels. This is marginally significant (p = 0.059406).

2.  Predictors

    -   **symptd3 or more:1**: The log-odds of being in the "over a year ago" category relative to "never" increase by 1.12136 for those with symptoms 3 or more compared to less than 3. This is statistically significant (p = 0.001693).

    -   **symptd3 or more:2**: The log-odds of being in the "within a year" category relative to "never" increase by 2.09534 for those with symptoms 3 or more compared to less than 3. This is highly significant (p \< 0.001).

    -   **pb:1**: The log-odds of being in the "over a year ago" category relative to "never" decrease by 0.16811 for each unit increase in perceived benefit. This is statistically significant (p = 0.023426).

    -   **pb:2**: The log-odds of being in the "within a year" category relative to "never" decrease by 0.25101 for each unit increase in perceived benefit. This is highly significant (p \< 0.001).

    -   **hist2yes:1**: The log-odds of being in the "over a year ago" category relative to "never" increase by 1.01406 for those with a family history of breast cancer compared to those without. This is statistically significant (p = 0.025446).

    -   **hist2yes:2**: The log-odds of being in the "within a year" category relative to "never" increase by 1.29383 for those with a family history of breast cancer compared to those without. This is highly significant (p = 0.002835).

    -   **bse:1**: The log-odds of being in the "over a year ago" category relative to "never" increase by 1.28509 for those with breast self-exam training compared to those without. This is statistically significant (p = 0.012473).

    -   **bse:2**: The log-odds of being in the "within a year" category relative to "never" increase by 1.24397 for those with breast self-exam training compared to those without. This is statistically significant (p = 0.018097).

    -   **detc22:1**: The log-odds of being in the "over a year ago" category relative to "never" decrease by 0.90213 for those in the second level of detection likelihood compared to the reference level. This is not statistically significant (p = 0.206813).

    -   **detc22:2**: The log-odds of being in the "within a year" category relative to "never" increase by 0.09028 for those in the second level of detection likelihood compared to the reference level. This is not statistically significant (p = 0.938011).

    -   **detc23:1**: The log-odds of being in the "over a year ago" category relative to "never" decrease by 0.66982 for those in the third level of detection likelihood compared to the reference level. This is not statistically significant (p = 0.329979).

    -   **detc23:2**: The log-odds of being in the "within a year" category relative to "never" increase by 0.97281 for those in the third level of detection likelihood compared to the reference level. This is not statistically significant (p = 0.387627).

3.  Interpretation

    -   The model includes additional covariates such as symptoms, perceived benefit, family history, breast self-exam training, and detection likelihood.
    -   Significant predictors include `symptd`, `pb`, `hist2`, and `bse`, indicating their impact on the likelihood of having a mammogram within a year or over a year ago relative to never.
    -   The model fit statistics suggest that the model adequately fits the data.
    -   Confidence intervals and RRRs provide further insights into the effects of these predictors.

### Convert `detc` to a Binary Variable

The variable `detc` initially has 3 categories. The aim is to recode it into a binary variable `detcd`.

```{r}
dat.m3 <- dat.m3 %>%
  mutate(detcd = ifelse(detc < 3, "<3", "3 or more"))
```

------------------------------------------------------------------------

-   `ifelse(detc < 3, '<3', '3 or more')`: This function checks the value of `detc` for each observation.
-   If `detc` is less than 3, it assigns the value '\<3' to `detcd`.
-   If `detc` is 3 or more, it assigns the value '3 or more' to `detcd`.
-   This effectively recodes `detc` from 3 categories into a binary variable with 2 categories: '\<3' and '3 or more'.

### Refit the Model with the New `detcd` Variable

```{r}
fitmlog5 <- vglm(me3 ~ symptd + pb + hist2 + bse + detcd,
  family = multinomial(),
  data = dat.m3
)
summary(fitmlog5)
```

------------------------------------------------------------------------

**Summary of Output**

1.  Intercepts

    -   **(Intercept):1**: The log-odds of being in the "over a year ago" category relative to "never" are -1.82388 when all predictors are at their reference levels. This is statistically significant (p = 0.032928).
    -   **(Intercept):2**: The log-odds of being in the "within a year" category relative to "never" are -2.62376 when all predictors are at their reference levels. This is highly significant (p = 0.004622).

2.  Predictors

    -   **symptd3 or more:1**: The log-odds of being in the "over a year ago" category relative to "never" increase by 1.12742 for those with symptoms 3 or more compared to less than 3. This is statistically significant (p = 0.001558).

    -   **symptd3 or more:2**: The log-odds of being in the "within a year" category relative to "never" increase by 2.09475 for those with symptoms 3 or more compared to less than 3. This is highly significant (p \< 0.001).

    -   **pb:1**: The log-odds of being in the "over a year ago" category relative to "never" decrease by 0.15432 for each unit increase in perceived benefit. This is statistically significant (p = 0.033587).

    -   **pb:2**: The log-odds of being in the "within a year" category relative to "never" decrease by 0.24947 for each unit increase in perceived benefit. This is highly significant (p \< 0.001).

    -   **hist2yes:1**: The log-odds of being in the "over a year ago" category relative to "never" increase by 1.06318 for those with a family history of breast cancer compared to those without. This is statistically significant (p = 0.018885).

    -   **hist2yes:2**: The log-odds of being in the "within a year" category relative to "never" increase by 1.38968 for those with a family history of breast cancer compared to those without. This is highly significant (p = 0.001520).

    -   **bse:1**: The log-odds of being in the "over a year ago" category relative to "never" increase by 0.95601 for those with breast self-exam training compared to those without. This is marginally significant (p = 0.059515).

    -   **bse:2**: The log-odds of being in the "within a year" category relative to "never" increase by 1.20137 for those with breast self-exam training compared to those without. This is statistically significant (p = 0.018557).

    -   **detcd3 or more:1**: The log-odds of being in the "over a year ago" category relative to "never" increase by 0.11416 for those with detection likelihood 3 or more compared to less than 3. This is not statistically significant (p = 0.719786).

    -   **detcd3 or more:2**: The log-odds of being in the "within a year" category relative to "never" increase by 0.88518 for those with detection likelihood 3 or more compared to less than 3. This is statistically significant (p = 0.012962).

3.  Interpretation

    -   The model includes covariates such as symptoms, perceived benefit, family history, breast self-exam training, and detection likelihood.
    -   Significant predictors include `symptd`, `pb`, `hist2`, and `bse`, indicating their impact on the likelihood of having a mammogram within a year or over a year ago relative to never.
    -   The model fit statistics suggest that the model adequately fits the data.
    -   Confidence intervals and RRRs provide further insights into the effects of these predictors.

## Inferences

1.  Retrieve the log-odds and RRRs (Relative Risk Ratios).
2.  Calculate the 95% Confidence Intervals (CIs) for both the log-odds and the RRRs.
3.  Combine these results into a table.
4.  Present the results in a table

### Retrieve Log-Odds and RRRs

The log-odds are the coefficients from the multinomial logistic regression model, and the RRRs are the exponentiated coefficients.

```{r}
b_rrr_fitmlog5 <- cbind(coef(fitmlog5), exp(coef(fitmlog5)))
```

-   **`coef(fitmlog5)`**: Extracts the coefficients (log-odds) from the model `fitmlog5`.
-   **`exp(coef(fitmlog5))`**: Exponentiates the coefficients to obtain the RRRs.
-   **`cbind(coef(fitmlog5), exp(coef(fitmlog5)))`**: Combines the log-odds and RRRs into one table.

### Calculate 95% Confidence Intervals

```{r}
ci_b_rrr_fitmlog5 <- cbind(confint(fitmlog5), exp(confint(fitmlog5)))
```

-   **`confint(fitmlog5)`**: Computes the 95% CIs for the log-odds.
-   **`exp(confint(fitmlog5))`**: Computes the 95% CIs for the RRRs by exponentiating the CIs for the log-odds.
-   **`cbind(confint(fitmlog5), exp(confint(fitmlog5)))`**: Combines the CIs for log-odds and RRRs into one table.

### Combine the Results into a Table

```{r}
res_fitmlog5 <- cbind(b_rrr_fitmlog5, ci_b_rrr_fitmlog5)
colnames(res_fitmlog5) <- c("b", "rrr", "lower 95% b", "upper 95% b", "lower 95% rrr", "upper 95% rrr")
```

-   **`cbind(b_rrr_fitmlog5, ci_b_rrr_fitmlog5)`**: Combines the log-odds, RRRs, and their CIs.
-   **`colnames(res_fitmlog5) <- c('b', 'rrr', 'lower 95% b', 'upper 95% b', 'lower 95% rrr', 'upper 95% rrr')`**: Renames the columns of the combined table for clarity.

### Display the Results

```{r}
kable(res_fitmlog5, digits = 3) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```

------------------------------------------------------------------------

-   **`library(knitr)`** and **`library(kableExtra)`**: Load the necessary libraries for table formatting.
-   **`kable(res_fitmlog5, digits = 3)`**: Creates a table with `res_fitmlog5` data, formatting the values to three decimal places.
-   **`kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))`**: Applies styling options to the table for better presentation.

**Interpretation**

------------------------------------------------------------------------

-   **(Intercept):1**

    -   The log-odds of being in the "over a year ago" category relative to "never" are -1.824 when all predictors are at their reference levels.
    -   The RRR indicates that the odds of being in the "over a year ago" category are 0.161 times those of "never".
    -   The CIs suggest this estimate is statistically significant.

-   **symptd3 or more:1**

    -   The log-odds of being in the "over a year ago" category relative to "never" increase by 1.127 for those with symptoms 3 or more compared to less than 3.
    -   The RRR indicates that the odds are 3.088 times higher.
    -   The CIs suggest this estimate is statistically significant.

-   **pb:1**

    -   The log-odds of being in the "over a year ago" category relative to "never" decrease by 0.154 for each unit increase in perceived benefit.
    -   The RRR indicates that the odds are 0.857 times lower.
    -   The CIs suggest this estimate is statistically significant.

-   **hist2yes:1**

    -   The log-odds of being in the "over a year ago" category relative to "never" increase by 1.063 for those with a family history of breast cancer compared to those without.
    -   The RRR indicates that the odds are 2.896 times higher.
    -   The CIs suggest this estimate is statistically significant.

-   **bse:1**

    -   The log-odds of being in the "over a year ago" category relative to "never" increase by 0.956 for those with breast self-exam training compared to those without.
    -   The RRR indicates that the odds are 2.601 times higher.
    -   The CIs suggest this estimate is marginally significant.

-   **detcd3 or more:1**

    -   The log-odds of being in the "over a year ago" category relative to "never" increase by 0.114 for those with detection likelihood 3 or more compared to less than 3.
    -   The RRR indicates that the odds are 1.121 times higher.
    -   The CIs suggest this estimate is not statistically significant.

------------------------------------------------------------------------

-   **(Intercept):2**

    -   The log-odds of being in the "within a year" category relative to "never" are -2.624 when all predictors are at their reference levels.
    -   The RRR indicates that the odds of being in the "within a year" category are 0.073 times those of "never".
    -   The CIs suggest this estimate is statistically significant.

-   **symptd3 or more:2**

    -   The log-odds of being in the "within a year" category relative to "never" increase by 2.095 for those with symptoms 3 or more compared to less than 3.
    -   The RRR indicates that the odds are 8.123 times higher.
    -   The CIs suggest this estimate is highly significant.

-   **pb:2**

    -   The log-odds of being in the "within a year" category relative to "never" decrease by 0.249 for each unit increase in perceived benefit.
    -   The RRR indicates that the odds are 0.779 times lower.
    -   The CIs suggest this estimate is highly significant.

-   **hist2yes:2**

    -   The log-odds of being in the "within a year" category relative to "never" increase by 1.310 for those with a family history of breast cancer compared to those without.
    -   The RRR indicates that the odds are 3.706 times higher.
    -   The CIs suggest this estimate is statistically significant.

-   **bse:2**

    -   The log-odds of being in the "within a year" category relative to "never" increase by 1.237 for those with breast self-exam training compared to those without.
    -   The RRR indicates that the odds are 3.445 times higher.
    -   The CIs suggest this estimate is statistically significant.

-   **detcd3 or more:2**

    -   The log-odds of being in the "within a year" category relative to "never" increase by 0.885 for those with detection likelihood 3 or more compared to less than 3.
    -   The RRR indicates that the odds are 2.423 times higher.
    -   The CIs suggest this estimate is statistically significant.

## Prediction

### Predict the Log Odds

Predict the log odds for the given multinomial logistic regression model (`fitmlog1`).

```{r}
# Predicts the log odds and display the first 6 observations
head(predict.vgam(fitmlog1, type = 'link'))
```

------------------------------------------------------------------------

-   **`predict.vgam(fitmlog1, type = 'link')`**: Predicts the log odds (logit values) for each observation using the model `fitmlog1`. The `type = 'link'` option specifies that the predictions should be on the logit (log-odds) scale.
-   **`head()`**: Displays the first 6 observations.
-   **log(mu\[,1\]/mu\[,3\])**: The predicted log odds of being in the "over a year ago" category vs. "never".
-   **log(mu\[,2\]/mu\[,3\])**: The predicted log odds of being in the "within a year" category vs. "never".

#### Manual Calculation of Log Odds

Manually verify these predictions using the coefficients from the model and the values of the predictors for that observation.

-   **(Intercept):1**: -1.2504928
-   **(Intercept):2**: -0.9509763
-   **hist2yes:1**: 1.0093308
-   **hist2yes:2**: 1.2565379

```{r}
head(dat.m1[1:3,])
```

##### 1st Observation (hist2 = no)

Logit for "over a year ago" (\[1\]) vs "never" (\[3\]):

$$
\text{logit}(P(\text{me3} = 1)) = \beta_0^{[1]} + \beta_{\text{hist2yes}}^{[1]} \cdot \text{hist2}
$$ $$
= -1.2504928 + 1.0093308 \cdot 0
$$ $$
= -1.2504928 + 0
$$ $$
= -1.2504928
$$

------------------------------------------------------------------------

Logit for "within a year" (\[2\]) vs "never" (\[3\]):

$$
\text{logit}(P(\text{me3} = 2)) = \beta_0^{[2]} + \beta_{\text{hist2yes}}^{[2]} \cdot \text{hist2}
$$ $$
= -0.9509763 + 1.2565379 \cdot 0
$$ $$
= -0.9509763 + 0
$$ $$
= -0.9509763
$$

##### 3rd Observation (hist2 = yes)

Logit for "over a year ago" (\[1\]) vs "never" (\[3\]):

$$
\text{logit}(P(\text{me3} = 1)) = \beta_0^{[1]} + \beta_{\text{hist2yes}}^{[1]} \cdot \text{hist2}
$$ $$
= -1.2504928 + 1.0093308 \cdot 1
$$ $$
= -1.2504928 + 1.0093308
$$ $$
= -0.241162
$$

------------------------------------------------------------------------

Logit for "within a year" (\[2\]) vs "never" (\[3\]):

$$
\text{logit}(P(\text{me3} = 2)) = \beta_0^{[2]} + \beta_{\text{hist2yes}}^{[2]} \cdot \text{hist2}
$$ $$
= -0.9509763 + 1.2565379 \cdot 1
$$ $$
= -0.9509763 + 1.2565379
$$ $$
= 0.3053816
$$

### Predict the Probability

Using `fitmlog1` model, the log odds for the 1st observation:

-   Log odds for "over a year ago": -1.2504928
-   Log odds for "within a year": -0.9509763

```{r}
# Predicts the probabilities for the first 6 observations
head(predict.vgam(fitmlog1, type = 'response'))
```

------------------------------------------------------------------------

-   **`predict.vgam(fitmlog1, type = 'response')`**: Predicts the probabilities for each outcome category for the observations using the model `fitmlog1`. The `type = 'response'` option specifies that the predictions should be on the probability scale.
-   **`head()`**: Displays the first 6 observations.
-   **over.a.year.ago**: Probability of being in the "over a year ago" category.
-   **within.a.year**: Probability of being in the "within a year" category.
-   **never**: Probability of being in the "never" category.

The calculations below demonstrate how to use the predicted log odds to derive the probabilities for each outcome category, ensuring that the probabilities sum to 1 for each observation.

#### Probability of Being in the Reference Group ("Never")

$$
P(\text{me3} = \text{never}) = \frac{1}{1 + \exp(\text{logit}_{\text{over a year ago}}) + \exp(\text{logit}_{\text{within a year}})}
$$ $$
P(\text{me3} = \text{never}) = \frac{1}{1 + \exp(-1.2504928) + \exp(-0.9509763)}
$$ $$
= \frac{1}{1 + 0.2865693 + 0.3867897}
$$ $$
= \frac{1}{1.673359}
$$ $$
= 0.5978261
$$

#### Probability of Being in the "Over a Year Ago" Group

$$
P(\text{me3} = \text{over a year ago}) = \frac{\exp(\text{logit}_{\text{over a year ago}})}{1 + \exp(\text{logit}_{\text{over a year ago}}) + \exp(\text{logit}_{\text{within a year}})}
$$ $$
P(\text{me3} = \text{over a year ago}) = \frac{\exp(-1.2504928)}{1 + \exp(-1.2504928) + \exp(-0.9509763)}
$$ $$
= \frac{0.2865693}{1 + 0.2865693 + 0.3867897}
$$ $$
= \frac{0.2865693}{1.673359}
$$ $$
= 0.1711957
$$

#### Probability of Being in the "Within a Year" Group

$$
P(\text{me3} = \text{within a year}) = \frac{\exp(\text{logit}_{\text{within a year}})}{1 + \exp(\text{logit}_{\text{over a year ago}}) + \exp(\text{logit}_{\text{within a year}})}
$$ $$
P(\text{me3} = \text{within a year}) = \frac{\exp(-0.9509763)}{1 + \exp(-1.2504928) + \exp(-0.9509763)}
$$ $$
= \frac{0.3867897}{1 + 0.2865693 + 0.3867897}
$$ $$
= \frac{0.3867897}{1.673359}
$$ $$
= 0.2309783
$$

# Practical 3: Alternative Approach

This exercise demonstrates an alternative approach to fitting a multinomial logistic regression model using the `multinom` function from the `nnet` package. It includes steps to fit the model, change the reference category, extract p-values, and compute confidence intervals.

In the `VGAM::vglm` function, the reference group is the category with the largest number of observations. In contrast, the `nnet::multinom` function uses the category with the smallest number of observations as the reference group.

## Estimation

### Fitting the Model

```{r}
# Fit the multinomial logistic regression model
mlog_nnet1 <- multinom(me3 ~ hist2, data = dat.m3)

# Summary of the model
summary(mlog_nnet1)
```

::: callout-note
Note that the reference group here is "over.a.year.ago" instead of "never."
:::

### Changing the Reference Category

```{r}
# Create new dataset and change the reference category
dat.m4 <- dat.m3
dat.m4 <- dat.m4 %>% mutate(me4 = relevel(me3, ref = "never"))

# Recheck the order of categories
levels(dat.m4$me4)
```

```{r}
# Fit the model with the new reference category
mlog_nnet2 <- multinom(me4~ hist2, data = dat.m4)

# Summary of the new model
summary(mlog_nnet2)
```

::: callout-note
The reference category is changed to "never," which affects the interpretation of the coefficients.
:::

## Inferences

### Getting P-Values

```{r}
# Calculate z-values
z.test <- summary(mlog_nnet2)$coefficients / summary(mlog_nnet2)$standard.errors

# Calculate p-values
p.val <- (1 - pnorm(abs(z.test), 0, 1)) * 2

colnames(p.val) <- c('p-val intercept', 'p-val hist')
p.val
```

------------------------------------------------------------------------

-   **z.test**: z-values calculated by dividing coefficients by their standard errors.
-   **p.val**: Two-tailed p-values calculated from the z-values.

### Confidence Intervals

```{r}
# Calculate confidence intervals
confint(mlog_nnet2, level = 0.95)
```

------------------------------------------------------------------------

-   **Confidence intervals**: Provide a range within which the true coefficient values are expected to lie with 95% confidence.

# Acknowledgment

I would like to express my gratitude to [Professor Dr. Kamarul Imran Musa](https://myanalytics.com.my/), Medical Epidemiologist and Statistician, and Professor in Epidemiology and Biostatistics at the School of Medical Sciences, Universiti Sains Malaysia, for his teaching and guidance on the subject matter.

# References

-   Lecture on Multinomial Logistic Regression by [Professor Dr. Kamarul Imran Musa](https://myanalytics.com.my/).
-   [Applied Logistic Regression, Second Edition by Hosmer and Lemeshow, Chapter 8: Special Topics](https://stats.idre.ucla.edu/stata/examples/alr2/applied-logistic-regression-second-edition-by-hosmer-and-lemeshowchapter-8-special-topics/). UCLA Institute for Digital Research & Education.
-   [STAT 504: Analysis of Discrete Data, Lesson 11: Multinomial Logistic Regression](https://onlinecourses.science.psu.edu/stat504/node/171). Penn State Eberly College of Science.
-   [R Data Analysis Examples: Multinomial Logistic Regression](https://stats.idre.ucla.edu/r/dae/multinomial-logistic-regression/). UCLA Institute for Digital Research & Education.
-   [The mlogit Package: Multinomial Logit Models in R](https://cran.r-project.org/web/packages/mlogit/vignettes/mlogit.pdf). Croissant, Y. (2021).
-   Long, J. S., & Freese, J. "Models for Nominal Outcomes." In *Regression Models for Categorical Dependent Variables Using Stata* (3rd ed.). Stata Press.
-   Hosmer, D. W. Jr., Lemeshow, S., & Sturdivant, R. X. (2013). *Special Topics*. In *Applied Logistic Regression* (3rd ed.). Wiley.

# R Codes

The R codes used in this analysis are available at the following GitHub repository: [DrPH-Epidemiology-Revision](https://github.com/drsaufi/DrPH-Epidemiology-Revision.git). This repository includes all scripts and data necessary to replicate the analyses presented in this work.
